<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QC Process</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --ring: rgba(59,130,246,.5);
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      transition: background-color .3s ease;
      padding: 2rem;
    }
    .card {
      background-color: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      padding: 2.5rem;
      margin-top: 2rem;
      transition: transform .3s ease;
    }
    .card:hover { transform: translateY(-5px); }
    .login-input {
      width: 100%;
      padding: .75rem;
      border: 1px solid #d1d5db;
      border-radius: .5rem;
      font-size: 1rem;
      transition: border-color .3s ease, box-shadow .3s ease;
      background: #fff;
    }
    .login-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px var(--ring);
    }
    .btn-primary {
      width: 100%;
      padding: .75rem;
      background-color: #3b82f6;
      color: #fff;
      border: none;
      border-radius: .75rem;
      font-size: 1.125rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color .2s ease, transform .05s ease;
    }
    .btn-primary:hover { background-color: #2563eb; }
    .btn-primary:active { transform: scale(.98); }
    .image-category-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: .5rem;
    }
    .image-card {
      position: relative;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      overflow: hidden;
      background-color: #f9fafb;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .image-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,.1);
    }
    .image-card img {
      width: 100%;
      height: auto;
      max-height: 250px;
      object-fit: contain;
      background: #fff;
    }
    .kbd {
      border: 1px solid #e5e7eb;
      border-bottom-width: 3px;
      border-radius: .5rem;
      padding: .1rem .4rem;
      font-size: .75rem;
      background: #f9fafb;
      color: #374151;
    }
  </style>
</head>

<body class="bg-gray-100">
  <div id="app" class="mx-auto">
    <!-- Login View -->
    <div id="login-view" class="card max-w-md mx-auto">
      <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">QC Login</h1>
      <form id="login-form" class="space-y-6">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <select id="email" class="login-input" required>
            <option value="shweta.gupta@spyne.co.in">shweta.gupta@spyne.co.in</option>
            <option value="abhishek.kumar@spyne.ai">abhishek.kumar@spyne.ai</option>
            <option value="Kishor@spyne.ai">Kishor@spyne.ai</option>
            <option value="Praveen.agarwal@spyne.ai">Praveen.agarwal@spyne.ai</option>
            <option value="sumit.rana@spyne.ai">sumit.rana@spyne.ai</option>
          </select>
        </div>

        <div>
          <label for="team-name" class="block text-sm font-medium text-gray-700 mb-1">Team Name</label>
          <select id="team-name" class="login-input" required>
            <!-- Populated from CSV -->
          </select>
        </div>

        <button type="submit" class="btn-primary">Login</button>
      </form>
    </div>

    <!-- QC View -->
    <div id="qc-view" class="hidden">
      <div class="px-8 py-4 max-w-7xl mx-auto">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2 mb-3">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-800" id="sku-name-display"></h1>
          <p class="text-base sm:text-lg text-gray-600" id="sku-id-display"></p>
        </div>

        <div class="text-sm text-gray-500 mb-2">
          Hotkeys:
          <span class="kbd">1</span> Sequence,
          <span class="kbd">2</span> Tilt,
          <span class="kbd">3</span> Issue,
          <span class="kbd">4</span> Option&nbsp;1,
          <span class="kbd">5</span> Option&nbsp;2,
          <span class="kbd">Enter</span> Submit
        </div>
      </div>

      <!-- Full-width image display -->
      <div id="image-display" class="space-y-6"></div>

      <div class="px-8 py-4 max-w-7xl mx-auto">
        <div class="card mt-8 flex flex-col items-center w-full">
          <div class="flex flex-wrap justify-center gap-6 mb-8">
            <label class="flex items-center text-gray-700 font-medium">
              <input type="checkbox" name="qc_option" value="Sequence" class="h-5 w-5 rounded-md text-blue-600">
              <span class="ml-2">Sequence</span>
            </label>
            <label class="flex items-center text-gray-700 font-medium">
              <input type="checkbox" name="qc_option" value="Tilt" class="h-5 w-5 rounded-md text-blue-600">
              <span class="ml-2">Tilt</span>
            </label>
            <label class="flex items-center text-gray-700 font-medium">
              <input type="checkbox" name="qc_option" value="Issue" class="h-5 w-5 rounded-md text-blue-600">
              <span class="ml-2">Issue</span>
            </label>
            <label class="flex items-center text-gray-700 font-medium">
              <input type="checkbox" name="qc_option" value="option1" class="h-5 w-5 rounded-md text-blue-600">
              <span class="ml-2">Option 1</span>
            </label>
            <label class="flex items-center text-gray-700 font-medium">
              <input type="checkbox" name="qc_option" value="option2" class="h-5 w-5 rounded-md text-blue-600">
              <span class="ml-2">Option 2</span>
            </label>
          </div>

          <button id="submit-btn" class="btn-primary w-64">Submit</button>
          <p class="mt-3 text-xs text-gray-500">
            If no option is selected, <strong>Status</strong> will be submitted as <strong>“Done”</strong>.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-xl text-center max-w-md w-full mx-3">
      <p id="modal-message" class="text-gray-800 text-lg"></p>
      <button id="modal-close-btn" class="mt-4 px-5 py-2.5 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">OK</button>
    </div>
  </div>

  <script>
    /***** CONFIG *****/
    const sheetUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vSG8Kx21fGcA06IVjoAARb1L656dTEBbzxfuBTXCn1rqDfYiP1AQeXDaD9WolWVlCn1CLFVjdXEHZXU/pub?gid=0&single=true&output=csv';

    // Google Form POST endpoint
    const formResponseUrl =
      'https://docs.google.com/forms/d/e/1FAIpQLSf--_CEKCjaq_opP3Fi1oU8qDeExUvVuCa3GJcTV4NETK8W7g/formResponse';

    // Match your Form entry IDs
    const entryIds = {
      email: 'entry.1543570917',
      teamName: 'entry.462099554',
      issueOptions: 'entry.1537009712', // "Status" field
      skuName: 'entry.1722677845',
      skuId: 'entry.1740050363'
    };

    // If your checkbox values differ from the labels expected by the Form,
    // map them here. Otherwise they’ll be sent as-is.
    const statusChoiceMap = {
      Sequence: 'Sequence',
      Tilt: 'Tilt',
      Issue: 'Issue',
      option1: 'Option 1',
      option2: 'Option 2'
    };

    /***** STATE + UI REFS *****/
    let allSkus = [];
    let currentSkuIndex = 0;

    const loginView = document.getElementById('login-view');
    const qcView = document.getElementById('qc-view');
    const loginForm = document.getElementById('login-form');
    const emailSelect = document.getElementById('email');
    const teamNameSelect = document.getElementById('team-name');
    const skuNameDisplay = document.getElementById('sku-name-display');
    const skuIdDisplay = document.getElementById('sku-id-display');
    const imageDisplay = document.getElementById('image-display');
    const submitBtn = document.getElementById('submit-btn');
    const modal = document.getElementById('modal');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    /***** HELPERS *****/
    function showModal(message) {
      modalMessage.textContent = message;
      modal.classList.remove('hidden');
    }
    modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));

    async function fetchCsvData() {
      try {
        const response = await fetch(sheetUrl);
        const text = await response.text();
        return text;
      } catch (err) {
        console.error('CSV fetch error:', err);
        showModal('Failed to load data. Please check network.');
        return null;
      }
    }

    function parseCsv(csvText) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().toLowerCase());

      const idx = {
        skuId: headers.indexOf('ai.sku_id'),
        skuName: headers.indexOf('sku_name'),
        teamName: headers.indexOf('team_name'),
        imageCategory: headers.indexOf('image_category'),
        outputImageUrl: headers.indexOf('output_image_hres_url'),
        status: headers.indexOf('status'),
        frameSeqNo: headers.indexOf('frame_seq_no')
      };

      // Basic header guards
      for (const [k, v] of Object.entries(idx)) {
        if (v === -1) {
          console.warn(`Missing column: ${k}`);
        }
      }

      const dataLines = lines.slice(1);
      const skus = {};
      const teamNames = new Set();
      const excludedStatuses = ['Tilt', 'Sequence', 'Issue'];

      dataLines.forEach(line => {
        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, ''));

        const status = values[idx.status]?.trim() ?? '';
        if (excludedStatuses.includes(status)) return;

        const sku_id = values[idx.skuId];
        const sku_name = values[idx.skuName];
        const team_name = values[idx.teamName];
        const image_category = values[idx.imageCategory];
        const output_image_url = values[idx.outputImageUrl];
        const frame_seq_no = values[idx.frameSeqNo];

        if (sku_id && sku_name && image_category && output_image_url) {
          if (!skus[sku_id]) {
            skus[sku_id] = { id: sku_id, name: sku_name, categories: {} };
          }
          if (!skus[sku_id].categories[image_category]) {
            skus[sku_id].categories[image_category] = [];
          }
          skus[sku_id].categories[image_category].push({
            id: sku_id,
            url: output_image_url,
            sequenceNo: frame_seq_no ? parseInt(frame_seq_no, 10) : 0
          });
        }

        if (team_name && team_name.trim() !== '') teamNames.add(team_name.trim());
      });

      return { skus: Object.values(skus), teamNames: Array.from(teamNames) };
    }

    function displayCurrentSku() {
      if (currentSkuIndex >= allSkus.length) {
        showModal('You have reviewed all available SKUs!');
        skuNameDisplay.textContent = 'All SKUs Reviewed';
        skuIdDisplay.textContent = '';
        imageDisplay.innerHTML = '';
        submitBtn.disabled = true;
        return;
      }

      const currentSku = allSkus[currentSkuIndex];

      skuNameDisplay.textContent = currentSku.name || 'N/A';
      skuIdDisplay.textContent = `SKU ID: ${currentSku.id}`;
      imageDisplay.innerHTML = '';

      // reset checkboxes
      document.querySelectorAll('input[name="qc_option"]').forEach(cb => (cb.checked = false));

      const orderedCategories = ['Exterior', 'Interior', 'Focus Shoot', 'Miscellaneous'];

      orderedCategories.forEach(category => {
        if (!currentSku.categories[category]) return;

        const section = document.createElement('div');
        section.className = 'my-4';

        section.innerHTML = `<h2 class="image-category-title px-8 py-4 max-w-7xl mx-auto">${category}</h2>`;

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 px-8';

        const sorted = currentSku.categories[category].sort((a, b) => a.sequenceNo - b.sequenceNo);

        sorted.forEach(image => {
          grid.insertAdjacentHTML(
            'beforeend',
            `
            <div class="image-card relative">
              <span class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs font-bold px-2 py-1 rounded-full">${image.sequenceNo}</span>
              <img src="${image.url}" alt="SKU ${currentSku.id} - ${category}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e5e7eb/7f8c8d?text=Image+Not+Found';">
            </div>
            `
          );
        });

        section.appendChild(grid);
        imageDisplay.appendChild(section);
      });
    }

    /***** EVENTS *****/
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showModal('Logging in and fetching data...');
      // Hide modal quickly to keep flow snappy
      setTimeout(() => modal.classList.add('hidden'), 400);

      loginView.classList.add('hidden');
      qcView.classList.remove('hidden');
      displayCurrentSku();
    });

    // Submit handler with "Done" fallback when no options are selected
    submitBtn.addEventListener('click', async () => {
      const currentSku = allSkus[currentSkuIndex];
      if (!currentSku) {
        showModal('No SKU to submit.');
        return;
      }

      const selectedValues = Array.from(
        document.querySelectorAll('input[name="qc_option"]:checked')
      ).map(cb => cb.value);

      // build payload
      const formData = new URLSearchParams();
      formData.append(entryIds.email, emailSelect.value);
      formData.append(entryIds.teamName, teamNameSelect.value);
      formData.append(entryIds.skuName, currentSku.name || '');
      formData.append(entryIds.skuId, currentSku.id || '');

      // If no option selected, mark Status = Done
      if (selectedValues.length === 0) {
        formData.append(entryIds.issueOptions, 'Done');
      } else {
        // Append each status using mapping (if any)
        selectedValues.forEach(v => {
          formData.append(entryIds.issueOptions, statusChoiceMap[v] ?? v);
        });
      }

      try {
        const response = await fetch(formResponseUrl, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        });

        if (response.ok || response.type === 'opaque') {
          currentSkuIndex++;
          displayCurrentSku();
        } else {
          showModal('Failed to submit data. Please try again.');
        }
      } catch (err) {
        console.error('Submission error:', err);
        showModal('An error occurred during submission. Please try again.');
      }
    });

    // Hotkeys
    document.addEventListener('keydown', (e) => {
      if (qcView.classList.contains('hidden')) return;

      switch (e.key) {
        case '1': document.querySelector('input[value="Sequence"]').click(); break;
        case '2': document.querySelector('input[value="Tilt"]').click(); break;
        case '3': document.querySelector('input[value="Issue"]').click(); break;
        case '4': document.querySelector('input[value="option1"]').click(); break;
        case '5': document.querySelector('input[value="option2"]').click(); break;
        case 'Enter': submitBtn.click(); break;
      }
    });

    /***** INIT *****/
    (async function init() {
      const csvText = await fetchCsvData();
      if (!csvText) return;

      const parsed = parseCsv(csvText);
      allSkus = parsed.skus;

      parsed.teamNames.forEach(team => {
        const opt = document.createElement('option');
        opt.value = team;
        opt.textContent = team;
        teamNameSelect.appendChild(opt);
      });
    })();
  </script>
</body>
</html>
